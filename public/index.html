<!DOCTYPE html>
<html lang="en" ng-app="PoolTournament">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pool Tournament</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style>
    /* Page layout */
    body {
      padding-top: 70px;
      padding-bottom: 70px;
    }
    .navbar-fixed-bottom .navbar-nav {
      margin: 0;
      width: 100%;
    }
    .navbar-fixed-bottom .navbar-nav li {
      float: left;
      width: 50%;
      text-align: center;
    }
    .navbar-fixed-bottom .navbar-nav li a {
      padding-top: 15px;
      padding-bottom: 15px;
    }

    /* Forms */
    @media (min-width: 768px) {
      .form-inline .form-group input {
        max-width: 110px;
      }
    }

    /* Result tables */
    .foul {
      color: #a94442;
    }
    .winner {
      font-weight: bold;
    }
    .starter {
      color: #428bca;
    }
    .winner::after {

    }
    .starter::after {

    }
    .winner.starter::after {

    }

    /* Tournament bracket */
    .scroll-x {
      overflow-x: scroll;
    }
    .node circle {
      cursor: pointer;
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
    .node text {
      font: 10px sans-serif;
    }
    path.link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    /* Stats */
    .row.well {
      margin-left: 0;
      margin-right: 0;
      padding-bottom: 0;
    }
    img.icon {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    p.number, h4 {
      color: #636467;
    }
    p.number {
      margin: 0;
      font-size: 44px;
      font-weight: 100;
    }
    h4 {
      margin-top: 0;
      margin-bottom: 29px;
      font-weight: 200;
    }
  </style>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.2/d3.min.js"></script>

  <!-- AngularJS -->
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-route.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-resource.min.js"></script>

  <!-- AngularJS templates -->
  <script type="text/ng-template" id="matches.html">
    <!-- Match result form -->
    <div class="row">
      <div class="panel panel-default">
        <div class="panel-body">
          <form class="form-inline" role="form" ng-submit="addMatch()">
            <div class="form-group">
              <label class="sr-only">Group:</label>
              <select class="form-control" ng-model="matchForm.group" ng-options="group for group in groups">
                <option value="">Group</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Date:</label>
              <input type="text" class="form-control" placeholder="Date" ng-model="matchForm.date">
            </div>
            <img src="http://placehold.it/30x30">
            <div class="form-group">
              <label class="sr-only">Winner:</label>
              <select class="form-control" ng-model="matchForm.winner" ng-options="player for player in players">
                <option value="">Winner</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Winner balls:</label>
              <select class="form-control" ng-model="matchForm.winnerBalls" ng-options="number for number in [8,7,6,5,4,3,2,1,0]">
                <option value="">Score</option>
              </select>
            </div>
            VS

            <img src="http://placehold.it/30x30">
            <div class="form-group">
              <label class="sr-only">Loser:</label>
              <select class="form-control" ng-model="matchForm.loser" ng-options="player for player in players">
                <option value="">Loser</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Loser balls:</label>
              <select class="form-control" ng-model="matchForm.loserBalls" ng-options="number for number in [0,1,2,3,4,5,6,7,8]">
                <option value="">Score</option>
              </select>
            </div>
            <button type="submit" class="btn btn-default pull-right" ng-disabled="!matchForm">Add</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Match results for each group -->
    <div class="row" ng-repeat="group in groups">
      <div class="panel panel-default">
        <div class="panel-heading">Group {{ group }}</div>
        <table class="table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Date</th>
              <th class="text-right">Winner</th>
              <th class="text-center">Results</th>
              <th>Loser</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="match in matches | filter:{group:group} | orderBy:'date'">
              <td class="text-center">{{ $index + 1 }}</td>
              <td>{{ match.date | date:'MMM d' }}</td>
              <td class="text-right">{{ match.winner }}</td>
              <td class="text-center" ng-class="{foul: isFoul(match)}">{{ match.winnerBalls }} : {{ match.loserBalls }}</td>
              <td>{{ match.loser }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </script>
  <script type="text/ng-template" id="points.html">
    <!-- Group table -->
    <div class="row" ng-repeat="group in groups">
      <div class="panel panel-default">
        <div class="panel-heading">Group {{ group }}</div>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Player</th>
                <th class="text-center">Played</th>
                <th class="text-center">Won</th>
                <th class="text-center">Lost</th>
                <th class="text-center">Pocketed</th>
                <th class="text-center">Points</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in rankPlayers(matchesByGroup(matches, group))" ng-class="{success: matchesByGroup(matches, group).length === 6 && $index < 2}">
                <td>{{ player }}</td>
                <td class="text-center">{{ (matches | filter:player).length }}</td>
                <td class="text-center">{{ (matches | filter:{winner:player}).length }}</td>
                <td class="text-center">{{ (matches | filter:{loser:player}).length }}</td>
                <td class="text-center">{{ countPockets(matches, player) }}</td>
                <td class="text-center">{{ (matches | filter:{winner:player}).length * 3 }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </script>
  <script type="text/ng-template" id="knockouts.html">
    <!-- Tournament bracket -->
    <div class="row scroll-x">
      <bracket data="fixtures"></bracket>
    </div>

    <!-- Knockout result form -->
    <div class="row">
      <div class="panel panel-default">
        <div class="panel-body">
          <form class="form-inline" role="form" novalidate ng-submit="updateKnockout()">
            <div class="form-group">
              <label class="sr-only">Match #:</label>
              <select class="form-control" ng-model="knockout" ng-options="match.number for match in knockouts | orderBy:'number'">
                <option value="">#</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Date:</label>
              <input type="text" class="form-control" placeholder="Date" ng-model="knockoutForm.date">
            </div>
            <div class="form-group">
              <label class="sr-only">Time:</label>
              <input type="number" class="form-control" placeholder="Time" ng-model="knockoutForm.time">
            </div>
            <div class="form-group">
              <label class="sr-only">Starter:</label>
              <select class="form-control" ng-model="knockoutForm.starter" ng-options="playerName(player) for player in players">
                <option value="">Starter</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Winner:</label>
              <select class="form-control" ng-model="knockoutForm.winner" ng-options="playerName(player) for player in players">
                <option value="">Winner</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Winner balls:</label>
              <select class="form-control" ng-model="knockoutForm.winnerBalls" ng-options="number for number in [8,7,6,5,4,3,2,1,0]">
                <option value="">W</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Loser balls:</label>
              <select class="form-control" ng-model="knockoutForm.loserBalls" ng-options="number for number in [0,1,2,3,4,5,6,7,8]">
                <option value="">L</option>
              </select>
            </div>
            <button type="submit" class="btn btn-default pull-right" ng-disabled="!knockoutForm">Update</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Knockout results -->
    <div class="row" ng-repeat="round in rounds">
      <div class="panel panel-default">
        <div class="panel-heading">{{ round.title }}</div>
        <table class="table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Date</th>
              <th class="text-center">Time</th>
              <th class="text-right"></th>
              <th class="text-center">Results</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="match in round.matches | orderBy:'number'">
              <td class="text-center">{{ match.number }}</td>
              <td>{{ match.date | date:'MMM d' }}</td>
              <td class="text-center">
                <span ng-if="!match.time">—</span>
                <span ng-if="match.time">{{ match.time }} min</span>
              </td>
              <td class="text-right" ng-class="{winner: match.player === match.winner, starter: match.player === match.starter}">{{ playerName(match.player) }}</td>
              <td class="text-center" ng-class="{foul: isFoul(match)}">
                <span ng-if="!match.winner">—</span>
                <span ng-if="match.winner">
                  {{ match.player === match.winner ? match.winnerBalls : match.loserBalls }} :
                  {{ match.opponent === match.winner ? match.winnerBalls : match.loserBalls }}
                </span>
              </td>
              <td ng-class="{winner: match.opponent === match.winner, starter: match.opponent === match.starter}">{{ playerName(match.opponent) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </script>
  <script type="text/ng-template" id="leaderboards.html">
    <!-- Tournament stats -->
    <div class="row well">
      <div class="col-sm-4 text-center">
        <img alt="Matches Played" class="icon" src="https://s3.amazonaws.com/oozou/assets/icn_codes-d5e19d28949cb888cce138c73e6d14fb.png">
        <p class="number">{{ results.length }}</p>
        <h4>Matches Played</h4>
      </div>
      <div class="col-sm-4 text-center">
        <img alt="Balls Pocketed" class="icon" src="https://s3.amazonaws.com/oozou/assets/icn_experience-825e82ff06b10350d13c93d470d5b776.png">
        <p class="number">{{ totalPockets }}</p>
        <h4>Balls Pocketed</h4>
      </div>
      <div class="col-sm-4 text-center">
        <img alt="Minutes Spent" class="icon" src="https://s3.amazonaws.com/oozou/assets/icn_project_launched-70209baf7f2f51501fa32c3a4446cadb.png">
        <p class="number">{{ totalTime }}</p>
        <h4>Minutes Spent</h4>
      </div>
    </div>

    <!-- Player stats -->
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">Most wins</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Player</th>
                <th class="text-center">Won</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in playerStats | orderBy:'-wins' | limitTo:5">
                <td class="text-center">{{ $index + 1 }}</td>
                <td>{{ player.name }}</td>
                <td class="text-center">{{ player.wins }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">Least wins</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Player</th>
                <th class="text-center">Won</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in playerStats | orderBy:'wins' | limitTo:5">
                <td class="text-center">{{ $index + 1 }}</td>
                <td>{{ player.name }}</td>
                <td class="text-center">{{ player.wins }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">Top pockets</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Player</th>
                <th class="text-center">Pocketed</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in playerStats | orderBy:'-pockets' | limitTo:5">
                <td class="text-center">{{ $index + 1 }}</td>
                <td>{{ player.name }}</td>
                <td class="text-center">{{ player.pockets }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">Luckiest players</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Player</th>
                <th class="text-center">Won on a foul</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in playerStats | orderBy:'-foulWins' | limitTo:5">
                <td class="text-center">{{ $index + 1 }}</td>
                <td>{{ player.name }}</td>
                <td class="text-center">{{ player.foulWins }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Match stats -->
    <div class="row">
      <div class="col-sm-12">
        <div class="panel panel-default">
          <div class="panel-heading">Longest match</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Date</th>
                <th class="text-center">Time</th>
                <th class="text-right"></th>
                <th class="text-center">Results</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="result in results | filter:timeRecorded | orderBy:'-time' | limitTo:1">
                <td class="text-center">{{ result.number }}</td>
                <td>{{ result.date | date:'MMM d' }}</td>
                <td class="text-center">
                  <span>{{ result.time }} min</span>
                </td>
                <td class="text-right winner">{{ result.winner }}</td>
                <td class="text-center" ng-class="{foul: isFoul(match)}">
                  <span>{{ result.winnerBalls }} : {{ result.loserBalls }}</span>
                </td>
                <td>{{ result.loser }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-sm-12">
        <div class="panel panel-default">
          <div class="panel-heading">Shortest match</div>
          <table class="table">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th>Date</th>
                <th class="text-center">Time</th>
                <th class="text-right"></th>
                <th class="text-center">Results</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="result in results | filter:timeRecorded | orderBy:'time' | limitTo:1">
                <td class="text-center">{{ result.number }}</td>
                <td>{{ result.date | date:'MMM d' }}</td>
                <td class="text-center">
                  <span>{{ result.time }} min</span>
                </td>
                <td class="text-right winner">{{ result.winner }}</td>
                <td class="text-center" ng-class="{foul: isFoul(match)}">
                  <span>{{ result.winnerBalls }} : {{ result.loserBalls }}</span>
                </td>
                <td>{{ result.loser }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </script>

  <!-- PoolTournament -->
  <script>
    var app = angular.module('PoolTournament', ['ngRoute', 'ngResource']);

    // Constants
    app.value('groups', ['A', 'B', 'C', 'D']);
    app.value('players', [
      "Art", "Bas", "Boat", "Book", "Fifth", "Ing", "Jo", "Kelly", "Hlung",
      "Michael", "Neng", "Neung", "North", "Nut", "Phat", "Sunny"
    ]);
    app.value('positions', {
      '1A': 'Neng',
      '2A': 'Ing',
      '1B': 'Sunny',
      '2B': 'North',
      '1C': 'Neung',
      '2C': 'Kelly',
      '1D': 'Boat',
      '2D': 'Fifth',
      'W25': null,
      'W26': null,
      'W27': null,
      'W28': null,
      'W29': null,
      'W30': null,
      'W31': null
    });
    app.value('fixtures', {
      "name": "W31",
      "left": [{
        "name": "W29",
        "left": [
          {
            "name": "W25",
            "left": [
              {"name": "1A"},
              {"name": "2B"}
            ]
          },
          {
            "name": "W26",
            "left": [
              {"name": "1C"},
              {"name": "2D"}
            ]
          }
        ],
      }],
      "right": [{
        "name": "W30",
        "right": [
          {
            "name": "W27",
            "right": [
              {"name": "2A"},
              {"name": "1B"}
            ]
          },
          {
            "name": "W28",
            "right": [
              {"name": "2C"},
              {"name": "1D"}
            ]
          }
        ]
      }]
    });
    app.value('results', [
      // Group A
      {number: '1', date: 'Feb 1', winner: 'Neng', winnerBalls: 8, loser: 'Ing', loserBalls: 5, foul: false},
      {number: '2', date: 'Feb 1', winner: 'Neng', winnerBalls: 8, loser: 'Michael', loserBalls: 7, foul: false},
      {number: '3', date: 'Feb 1', winner: 'Ing', winnerBalls: 5, loser: 'Phat', loserBalls: 5, foul: true},
      {number: '4', date: 'Feb 21', winner: 'Ing', winnerBalls: 8, loser: 'Michael', loserBalls: 5, foul: false},
      {number: '5', date: 'Mar 3', winner: 'Neng', winnerBalls: 8, loser: 'Phat', loserBalls: 3, foul: false},
      {number: '6', date: 'Mar 7', winner: 'Phat', winnerBalls: 8, loser: 'Michael', loserBalls: 6, foul: false},

      // Group B
      {number: '7', date: 'Feb 1', winner: 'North', winnerBalls: 8, loser: 'Nut', loserBalls: 7, foul: false},
      {number: '8', date: 'Feb 1', winner: 'Jo', winnerBalls: 8, loser: 'Nut', loserBalls: 7, foul: false},
      {number: '9', date: 'Feb 1', winner: 'Sunny', winnerBalls: 8, loser: 'Nut', loserBalls: 7, foul: false},
      {number: '10', date: 'Feb 1', winner: 'North', winnerBalls: 8, loser: 'Jo', loserBalls: 6, foul: false},
      {number: '11', date: 'Feb 1', winner: 'Sunny', winnerBalls: 8, loser: 'North', loserBalls: 7, foul: false},
      {number: '12', date: 'Feb 21', winner: 'Jo', winnerBalls: 6, loser: 'Sunny', loserBalls: 8, foul: true},

      // Group C
      {number: '13', date: 'Feb 1', winner: 'Neung', winnerBalls: 8, loser: 'Hlung', loserBalls: 6, foul: false},
      {number: '14', date: 'Feb 1', winner: 'Neung', winnerBalls: 8, loser: 'Art', loserBalls: 2, foul: false},
      {number: '15', date: 'Feb 1', winner: 'Neung', winnerBalls: 7, loser: 'Kelly', loserBalls: 8, foul: true},
      {number: '16', date: 'Feb 1', winner: 'Art', winnerBalls: 8, loser: 'Hlung', loserBalls: 5, foul: false},
      {number: '17', date: 'Feb 21', winner: 'Kelly', winnerBalls: 8, loser: 'Art', loserBalls: 7, foul: false},
      {number: '18', date: 'Feb 21', winner: 'Hlung', winnerBalls: 8, loser: 'Kelly', loserBalls: 5, foul: false},

      // Group D
      {number: '19', date: 'Feb 1', winner: 'Boat', winnerBalls: 8, loser: 'Fifth', loserBalls: 6, foul: false},
      {number: '20', date: 'Feb 1', winner: 'Fifth', winnerBalls: 7, loser: 'Book', loserBalls: 8, foul: true},
      {number: '21', date: 'Feb 1', winner: 'Boat', winnerBalls: 8, loser: 'Book', loserBalls: 6, foul: false},
      {number: '22', date: 'Mar 7', winner: 'Fifth', winnerBalls: 8, loser: 'Bas', loserBalls: 3, foul: false},
      {number: '23', date: 'Mar 7', winner: 'Boat', winnerBalls: 7, loser: 'Bas', loserBalls: 8, foul: true},
      {number: '24', date: 'Mar 11', winner: 'Bas', winnerBalls: 8, loser: 'Book', loserBalls: 5, foul: false},

      // Round of 8
      {number: '25', date: 'Mar 12', time: 8, starter: 'North', winner: 'Neng', winnerBalls: 8, loser: 'North', loserBalls: 7, foul: false},
      {number: '26', date: 'Mar 13', time: 4, starter: 'Fifth', winner: 'Neung', winnerBalls: 5, loser: 'Fifth', loserBalls: 1, foul: true},
      {number: '27', date: 'Mar 12', time: 8, starter: 'Ing', winner: 'Ing', winnerBalls: 8, loser: 'Sunny', loserBalls: 4, foul: false},
      {number: '28', date: 'Mar 17', time: 10, starter: 'Boat', winner: 'Kelly', winnerBalls: 8, loser: 'Boat', loserBalls: 6, foul: false},

      // Semi-finals
      {number: '29', date: 'Mar 17', time: 9, starter: 'Neung', winner: 'Neung', winnerBalls: 8, loser: 'Neng', loserBalls: 6, foul: false},
      {number: '30', date: 'Mar 17', time: 10, starter: 'Ing', winner: 'Ing', winnerBalls: 8, loser: 'Kelly', loserBalls: 7, foul: false},

      // Final
      {number: '31', date: 'Mar 18', time: 19, starter: 'Neung', winner: 'Neung', winnerBalls: 8, loser: 'Ing', loserBalls: 7, foul: false},
    ]);

    // Routes
    app.config(function($routeProvider, $locationProvider) {
      $routeProvider.when('/', {
        controller: 'MatchesController',
        templateUrl: 'matches.html',
        resolve: {
          matches: function($location, Match) {
            return Match.query(function(matches) {
              if (matches.length >= 24) {
                $location.path('/knockout');
              }
            });
          }
        }
      });

      $routeProvider.when('/group', {
        controller: 'MatchesController',
        templateUrl: 'matches.html',
        resolve: {
          matches: function(Match) {
            return Match.query();
          }
        }
      });

      $routeProvider.when('/point', {
        controller: 'PointsController',
        templateUrl: 'points.html'
      });

      $routeProvider.when('/knockout', {
        controller: 'KnockoutsController',
        templateUrl: 'knockouts.html'
      });

      $routeProvider.when('/leaderboard', {
        controller: 'LeaderboardsController',
        templateUrl: 'leaderboards.html'
      });

      $routeProvider.otherwise({
        redirectTo: '/'
      });

      // configure html5 to get links working on jsfiddle
      $locationProvider.html5Mode(true);
    });


    // Services
    app.factory('Match', function($resource) {
      return $resource('/matches/:id', {id: '@id', format: 'json'}, {update: {method: 'PUT'}});
    });

    app.factory('Knockout', function($resource) {
      return $resource('/knockouts/:id', {id: '@id', format: 'json'}, {update: {method: 'PUT'}});
    });

    app.controller('AppController', function($scope, $location) {
      $scope.$location = $location;
      $scope.isActive = function(route) {
        return route === $location.path();
      }
    });

    app.directive('bracket', function() {
      return {
        restrict: 'E',
        scope: {data: '='},
        link: function(scope, element, attrs) {

          // Re-render bracket when data changes
          scope.$watch('data', function(data) {
            if (data) { render(angular.copy(data)); }
          }, true);

          // D3 Bracket Layout
          // http://bl.ocks.org/jdarling/2503502
          var margin = {top: 0, right: 0, bottom: 0, left: 0},
              width = 960 - margin.left - margin.right,
              halfWidth = width / 2,
              height = 500 - margin.top - margin.bottom,
              i = 0,
              duration = 500;

          var getChildren = function(d) {
                var a = [];
                if (d.left) {
                  for (var i = 0; i < d.left.length; i++) {
                    d.left[i].isRight = false;
                    d.left[i].parent = d;
                    a.push(d.left[i]);
                  }
                }
                if (d.right) {
                  for (var i = 0; i < d.right.length; i++) {
                    d.right[i].isRight = true;
                    d.right[i].parent = d;
                    a.push(d.right[i]);
                  }
                }
                return a.length ? a : null;
              }
          var tree = d3.layout.tree().size([height, width]);

          var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });
          var elbow = function (d, i) {
                var source = calcLeft(d.source);
                var target = calcLeft(d.target);
                var hy = (target.y - source.y) / 2;
                if (d.isRight) { hy = -hy };
                return "M" + source.y + "," + source.x + "H" + (source.y + hy) + "V" + target.x + "H" + target.y;
              };
          var connector = elbow;

          var calcLeft = function(d) {
                var l = d.y;
                if (!d.isRight) {
                  l = d.y - halfWidth;
                  l = halfWidth - l;
                }
                return {x: d.x, y: l};
              };

          var vis = d3.select(element[0]).append("svg")
                      .attr("width", width + margin.right + margin.left)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          function render(root) {
            root.x0 = height / 2;
            root.y0 = width / 2;

            var t1 = d3.layout.tree().size([height, halfWidth]).children(function(d) { return d.left; }),
                t2 = d3.layout.tree().size([height, halfWidth]).children(function(d) { return d.right; });
            t1.nodes(root);
            t2.nodes(root);

            var rebuildChildren = function(node) {
              node.children = getChildren(node);
              if (node.children) { node.children.forEach(rebuildChildren) };
            }
            rebuildChildren(root);
            root.isRight = false;

            // Compute the new tree layout.
            var toArray = function(item, arr) {
              arr = arr || [];
              var i = 0, l = item.children ? item.children.length : 0;
              arr.push(item);
              for (; i < l; i++) {
                toArray(item.children[i], arr);
              }
              return arr;
            };
            var nodes = toArray(root);

            // Normalize for fixed-depth.
            nodes.forEach(function(d) { d.y = d.depth * 150 + halfWidth; });

            // Update the nodes…
            var node = vis.selectAll("g.node")
                          .data(nodes, function(d) { return d.id || (d.id = ++i); });

            // Enter any new nodes at the parent's previous position.
            var nodeEnter = node.enter().append("g")
                                .attr("class", "node")
                                .attr("transform", function(d) { return "translate(" + root.y0 + "," + root.x0 + ")"; });

            nodeEnter.append("circle")
                     .attr("r", 1e-6)
                     .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

            nodeEnter.append("text")
                     .attr("dy", function(d) { return d.isRight ? 14 : -8;})
                     .attr("text-anchor", "middle")
                     .text(function(d) { return d.name; })
                     .style("fill-opacity", 1e-6);

            // Transition nodes to their new position.
            var nodeUpdate = node.transition()
                                 .duration(duration)
                                 .attr("transform", function(d) {
                                   p = calcLeft(d);
                                   return "translate(" + p.y + "," + p.x + ")";
                                 });

            nodeUpdate.select("circle")
                      .attr("r", 4.5)
                      .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

            nodeUpdate.select("text")
                      .style("fill-opacity", 1);

            // Transition exiting nodes to the parent's new position.
            var nodeExit = node.exit().transition()
                               .duration(duration)
                               .attr("transform", function(d) {
                                  p = calcLeft(d.parent || root);
                                  return "translate(" + p.y + "," + p.x + ")";
                               })
                               .remove();

            nodeExit.select("circle")
                    .attr("r", 1e-6);

            nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

            // Update the links...
            var link = vis.selectAll("path.link")
                          .data(tree.links(nodes), function(d) { return d.target.id; });

            // Enter any new links at the parent's previous position.
            link.enter().insert("path", "g")
                        .attr("class", "link")
                        .attr("d", function(d) {
                          var o = {x: root.x0, y: root.y0};
                          return connector({source: o, target: o});
                        });

            // Transition links to their new position.
            link.transition()
                .duration(duration)
                .attr("d", connector);

            // Transition exiting nodes to the parent's new position.
            link.exit().transition()
                .duration(duration)
                .attr("d", function(d) {
                  var o = calcLeft(d.source || root);
                  if (d.source.isRight) { o.y -= halfWidth - (d.target.y - d.source.y); }
                  else { o.y += halfWidth - (d.target.y - d.source.y); }
                  return connector({source: o, target: o});
                })
                .remove();

            // Stash the old positions for transition.
            nodes.forEach(function(d) {
              var p = calcLeft(d);
              d.x0 = p.x;
              d.y0 = p.y;
            });
          }
        },
      };
    });

    // Controllers
    app.controller('MatchesController', function($scope, $location, $route, Match, matches, groups, players, dateFilter) {
      $scope.matches = matches;
      $scope.groups = groups;
      $scope.players = players;
      $scope.isFoul = function(match) {
        return match.winnerBalls && match.winnerBalls !== 8;
      }
      $scope.addMatch = function() {
        $scope.matchForm.$save($scope.resetForm);
        $route.reload();
      }
      $scope.resetForm = function() {
        $scope.matchForm = new Match({date: new Date(), winnerBalls: 8, loserBalls: 0});
        $scope.matchForm.date = dateFilter($scope.matchForm.date, 'MMM d');
      }
      $scope.resetForm();
    });

    app.controller('PointsController', function($scope, Match, groups) {
      Match.query(function(matches) {
        $scope.matches = matches;
      });
      $scope.groups = groups;
      $scope.matchesByGroup = function(matches, group) {
        return _.filter(matches, function(match) {
          return match.group === group;
        });
      }
      $scope.findPlayers = function(matches) {
        return _.uniq(_.flatten(_.map(matches, function(match){
          return [match.winner, match.loser];
        })));
      }
      $scope.rankPlayers = function(matches) {
        var players = $scope.findPlayers(matches);
        var winCounts = _.countBy(matches, function(match) {
          return match.winner;
        });
        return _.sortBy(players, function(player) {
          var wins = winCounts[player] || 0;
          var pockets = $scope.countPockets(matches, player);
          return [wins, pockets];
        }).reverse();
      }
      $scope.countPockets = function(matches, player) {
        return _.reduce(matches, function(counts, match){
          if (match.winner === player) {
            return counts + match.winnerBalls;
          } else if (match.loser === player) {
            return counts + match.loserBalls;
          } else {
            return counts;
          }
        }, 0);
      }
    });

    app.controller('KnockoutsController', function($scope, Knockout, dateFilter, positions, fixtures) {
      $scope.refresh = function() {
        Knockout.query(function(knockouts) {
          $scope.knockouts = _.sortBy(knockouts, 'number');
          $scope.rounds = [
            {title: 'Round of 8', matches: $scope.knockouts.slice(0,4)},
            {title: 'Semi-finals', matches: $scope.knockouts.slice(4,6)},
            {title: 'Final', matches: $scope.knockouts.slice(-1)}
          ];
          updatePositions();
          $scope.fixtures = latestFixtures();
        });

        function updatePositions() {
          _.each($scope.knockouts, function(knockout) {
            if (knockout.winner) {
              positions['W' + knockout.number] = $scope.playerName(knockout.winner);
            }
          });
        }

        function latestFixtures() {
          var _fixtures = angular.copy(fixtures);
          updateFixtures(_fixtures);
          return _fixtures;
        }

        function updateFixtures(fixture) {
          _.each(angular.copy(fixture), function(value, key) {
            if (key === 'name') {
              fixture[key] = $scope.playerName(value);
            } else if (angular.isArray(value)) {
              _.each(value, function(element, index) {
                updateFixtures(fixture[key][index]);
              });
            }
          });
        }
      }
      $scope.isFoul = function(match) {
        return match.winnerBalls && match.winnerBalls !== 8;
      }
      $scope.updateKnockout = function() {
        $scope.knockoutForm.$update(function(knockout) {
          $scope.refresh();
          $scope.resetForm();
        });
      }
      $scope.resetForm = function() {
        delete $scope.knockout;
        delete $scope.knockoutForm;
        delete $scope.players;
      }
      $scope.playerName = function(position) {
        return positions[position] || position;
      }

      $scope.$watch('knockout', function(knockout) {
        if (knockout) {
          $scope.knockoutForm = angular.copy(knockout);
          $scope.knockoutForm.date = dateFilter($scope.knockoutForm.date, 'MMM d');
          $scope.players = [$scope.knockoutForm.player, $scope.knockoutForm.opponent];
        } else {
          $scope.resetForm();
        }
      });

      $scope.refresh();
    });

    app.controller('LeaderboardsController', function($scope, results, players) {
      $scope.results = results;
      $scope.totalPockets = calcTotalPockets();
      $scope.totalTime = calcTotalTime();
      $scope.playerStats = calcPlayerStats();
      $scope.timeRecorded = function(result) { return !!result.time; };

      function calcTotalPockets() {
        var totalPockets = 0;
        _.each(results, function(result) {
          var pockets = result.winnerBalls + result.loserBalls;
          totalPockets = totalPockets + pockets;
        });
        return totalPockets;
      }

      function calcTotalTime() {
        var totalTime = 0;
        _.each(results, function(result) {
          var time = result.time || 10;
          totalTime = totalTime + time;
        });
        return totalTime;
      }

      function calcPlayerStats() {
        var playerStats = [];
        _.each(players, function(player) {
          playerStats.push(
            {
              name: player,
              wins: countWins(results, player),
              foulWins: countFoulWins(results, player),
              pockets: countPockets(results, player),
            }
          );
        });
        return playerStats;
      }

      function countPockets(matches, player) {
        return _.reduce(matches, function(counts, match){
          if (match.winner === player) {
            return counts + match.winnerBalls;
          } else if (match.loser === player) {
            return counts + match.loserBalls;
          } else {
            return counts;
          }
        }, 0);
      }

      function countWins(matches, player) {
        return _.filter(matches, function(match) {
          return match.winner == player;
        }).length;
      }

      function countFoulWins(matches, player) {
        return _.filter(matches, function(match) {
          return match.winner == player && match.foul;
        }).length;
      }
    });
  </script>
</head>
<body ng-controller="AppController">
  <!-- Top navigation -->
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Pool Tournament</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li ng-class="{active: isActive('/') || isActive('/group') || isActive('/point') }"><a href="/group">Group stage</a></li>
          <li ng-class="{active: isActive('/knockout')}"><a href="/knockout">Knockout stage</a></li>
          <li ng-class="{active: isActive('/leaderboard')}"><a href="/leaderboard">Leaderboard</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Middle content -->
  <div class="container">
    <ng-view></ng-view>
  </div>

  <!-- Bottom navigation -->
  <nav class="navbar navbar-default navbar-fixed-bottom" role="navigation" ng-hide="$location.path() === '/knockout' || $location.path() === '/leaderboard'">
    <div class="container">
      <div class="row">
        <ul class="nav navbar-nav">
          <li ng-class="{active: isActive('/') || isActive('/group')}"><a href="/group">Matches</a></li>
          <li ng-class="{active: isActive('/point')}"><a href="/point">Points</a></li>
        </ul>
      </div>
    </div>
  </nav>
</body>
</html>
