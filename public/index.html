<!DOCTYPE html>
<html lang="en" ng-app="PoolTournament">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pool Tournament</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style>
    /* Page layout */
    body {
      padding-top: 70px;
      padding-bottom: 70px;
    }
    .navbar-fixed-bottom .navbar-nav {
      margin: 0;
      width: 100%;
    }
    .navbar-fixed-bottom .navbar-nav li {
      float: left;
      width: 50%;
      text-align: center;
    }
    .navbar-fixed-bottom .navbar-nav li a {
      padding-top: 15px;
      padding-bottom: 15px;
    }

    /* Result tables */
    .foul {
      color: #a94442;
    }
    .winner {
      font-weight: bold;
    }
    .starter {
      color: #428bca;
    }
    .winner::after {

    }
    .starter::after {

    }
    .winner.starter::after {
      
    }

    /* Tournament bracket */
    .node circle {
      cursor: pointer;
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
    .node text {
      font: 10px sans-serif;
    }
    path.link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-route.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-resource.min.js"></script>
  <script src="http://mbostock.github.com/d3/d3.v2.js"></script>
  <script type="text/ng-template" id="matches.html">
    <!-- Match result form -->
    <div class="row">
      <div class="panel panel-default">
        <div class="panel-body">
          <form class="form-inline" role="form" ng-submit="addMatch()">
            <div class="form-group">
              <label class="sr-only">Group:</label>
              <select class="form-control" required ng-model="match.group">
                <option value="">Group</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Winner:</label>
              <select class="form-control" required ng-model="match.winner">
                <option value="">Winner</option>
                <option value="{{ player }}" ng-repeat="player in players">{{ player }}</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Winner balls:</label>
              <select class="form-control" required ng-model="match.winnerBalls">
                <option value="8">8</option>
                <option value="7">7</option>
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
                <option value="0">0</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Loser:</label>
              <select class="form-control" required ng-model="match.loser">
                <option value="">Loser</option>
                <option value="{{ player }}" ng-repeat="player in players">{{ player }}</option>
              </select>
            </div>
            <div class="form-group">
              <label class="sr-only">Loser balls:</label>
              <select class="form-control" required ng-model="match.loserBalls">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </div>
            <div class="checkbox">
              <label><input type="checkbox" ng-model="match.foul"> Foul</label>
            </div>
            <button type="submit" class="btn btn-default pull-right">Add Result</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Match results for each group -->
    <div class="row" ng-repeat="group in groups">
      <div class="panel panel-default">
        <div class="panel-heading">Group {{ group }}</div>
        <table class="table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Date</th>
              <th class="text-right">Winner</th>
              <th class="text-center">Results</th>
              <th>Loser</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="match in matches | filter:{group:group} | orderBy:match.date">
              <td class="text-center">{{ $index + 1 }}</td>
              <td>{{ match.date | date:'MMM d' }}</td>
              <td class="text-right">{{ match.winner }}</td>
              <td class="text-center" ng-class="{foul: match.foul}">{{ match.winnerBalls }} : {{ match.loserBalls }}</td>
              <td>{{ match.loser }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </script>
  <script type="text/ng-template" id="points.html">
    <!-- Group table -->
    <div class="row" ng-repeat="group in groups">
      <div class="panel panel-default">
        <div class="panel-heading">Group {{ group }}</div>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Player</th>
                <th class="text-center">Played</th>
                <th class="text-center">Won</th>
                <th class="text-center">Lost</th>
                <th class="text-center">Pocketed</th>
                <th class="text-center">Points</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="player in rankPlayers(matchesByGroup(matches, group))" ng-class="{success: matchesByGroup(matches, group).length === 6 && $index < 2}">
                <td>{{ player }}</td>
                <td class="text-center">{{ (matches | filter:player).length }}</td>
                <td class="text-center">{{ (matches | filter:{winner:player}).length }}</td>
                <td class="text-center">{{ (matches | filter:{loser:player}).length }}</td>
                <td class="text-center">{{ countPocketed(matches, player) }}</td>
                <td class="text-center">{{ (matches | filter:{winner:player}).length * 3 }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </script>
  <script type="text/ng-template" id="knockout.html">
    <!-- Tournament bracket -->
    <div class="row">
      <figure style="margin-bottom:20px"></figure>
    </div>

    <!-- Knockout results -->
    <div class="row" ng-repeat="round in rounds">
      <div class="panel panel-default">
        <div class="panel-heading">{{ round.title }}</div>
        <table class="table">
          <thead>
            <tr>
              <th class="text-center">#</th>
              <th>Date</th>
              <th class="text-center">Time</th>
              <th class="text-right"></th>
              <th class="text-center">Results</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="match in round.matches | orderBy:match.number">
              <td class="text-center">{{ match.number }}</td>
              <td>{{ match.date | date:'MMM d' }}</td>
              <td class="text-center">
                <span ng-if="!match.time">—</span>
                <span ng-if="match.time">{{ match.time }} min</span>
              </td>
              <td class="text-right" ng-class="{winner: match.player === match.winner, starter: match.player === match.starter}">{{ match.player }}</td>
              <td class="text-center" ng-class="{foul: isFoul(match)}">
                <span ng-if="!match.winner">—</span>
                <span ng-if="match.winner">
                  {{ match.player === match.winner ? match.winnerBalls : match.loserBalls }} :
                  {{ match.opponent === match.winner ? match.winnerBalls : match.loserBalls }}
                </span>
              </td>
              <td ng-class="{winner: match.opponent === match.winner, starter: match.opponent === match.starter}">{{ match.opponent }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div id="chart"></div>
    <script src="bracketd3.js"></script>

  </script>
  <script>
    var app = angular.module('PoolTournament', ['ngRoute', 'ngResource']);

    app.value('groups', ['A', 'B', 'C', 'D']);
    app.value('players', [
      "Art", "Bas", "Boat", "Book", "Fifth", "Ing", "Jo", "Kelly", "Lhung",
      "Michael", "Neng", "Neung", "North", "Nut", "Phat", "Sunny"
    ]);

    app.config(function($routeProvider, $locationProvider) {
      $routeProvider.when('/', {
        controller: 'MatchesController',
        templateUrl: 'matches.html'
      });

      $routeProvider.when('/points', {
        controller: 'PointsController',
        templateUrl: 'points.html'
      });

      $routeProvider.when('/knockout', {
        controller: 'KnockoutController',
        templateUrl: 'knockout.html'
      });

      $routeProvider.otherwise({
        redirectTo: '/'
      });

      // configure html5 to get links working on jsfiddle
      $locationProvider.html5Mode(true);
    });

    app.factory('Match', function($resource) {
      return $resource('/matches/:id', {format: 'json'}, {update: {method: 'PUT'}});
    });

    app.factory('Knockout', function($resource) {
      return $resource('/knockouts/:id', {format: 'json'}, {update: {method: 'PUT'}});
    });

    app.controller('AppController', function($scope, $location) {
      $scope.$location = $location;
      $scope.isActive = function(route) {
        return route === $location.path();
      }
    });

    app.controller('MatchesController', function($scope, $route, Match, groups, players) {
      Match.query(function(matches) {
        $scope.matches = matches;
        $scope.match = new Match({winnerBalls: 8, loserBalls: 0});
      });
      $scope.groups = groups;
      $scope.players = players;
      $scope.addMatch = function() {
        $scope.match.date = new Date();
        $scope.match.$save();
        $route.reload();
      }
    });

    app.controller('PointsController', function($scope, Match, groups) {
      Match.query(function(matches) {
        $scope.matches = matches;
      });
      $scope.groups = groups;
      $scope.matchesByGroup = function(matches, group) {
        return _.filter(matches, function(match) {
          return match.group === group;
        });
      }
      $scope.findPlayers = function(matches) {
        return _.uniq(_.flatten(_.map(matches, function(match){
          return [match.winner, match.loser];
        })));
      }
      $scope.rankPlayers = function(matches) {
        var players = $scope.findPlayers(matches);
        var winCounts = _.countBy(matches, function(match) {
          return match.winner;
        });
        return _.sortBy(players, function(player) {
          var wins = winCounts[player] || 0;
          var pockets = $scope.countPocketed(matches, player);
          return [wins, pockets];
        }).reverse();
      }
      $scope.countPocketed = function(matches, player) {
        return _.reduce(matches, function(counts, match){
          if (match.winner === player) {
            return counts + match.winnerBalls;
          } else if (match.loser === player) {
            return counts + match.loserBalls;
          } else {
            return counts;
          }
        }, 0);
      }
    });

    app.controller('KnockoutController', function($scope, Knockout) {
      Knockout.query(function(knockouts) {
        $scope.knockouts = _.sortBy(knockouts, 'number');
        $scope.rounds = [
          {title: 'Round of 8', matches: $scope.knockouts.slice(0,4)},
          {title: 'Semi-finals', matches: $scope.knockouts.slice(4,6)},
          {title: 'Final', matches: $scope.knockouts.slice(-1)}
        ];
      });
      $scope.isFoul = function(match) {
        return match.winnerBalls && match.winnerBalls !== 8;
      }
    });
  </script>
</head>
<body ng-controller="AppController">
  <!-- Top navigation -->
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Pool Tournament</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li ng-class="{active: isActive('/') || isActive('/points')}"><a href="/">Group stage</a></li>
          <li ng-class="{active: isActive('/knockout')}"><a href="/knockout">Knockout stage</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Middle content -->
  <div class="container">
    <ng-view></ng-view>
  </div>

  <!-- Bottom navigation -->
  <nav class="navbar navbar-default navbar-fixed-bottom" role="navigation" ng-hide="$location.path() === '/knockout'">
    <div class="container">
      <div class="row">
        <ul class="nav navbar-nav">
          <li ng-class="{active: isActive('/')}"><a href="/">Matches</a></li>
          <li ng-class="{active: isActive('/points')}"><a href="/points">Points</a></li>
        </ul>
      </div>
    </div>
  </nav>
</body>
</html>